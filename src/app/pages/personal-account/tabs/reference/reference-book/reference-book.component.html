<div class="container">

    <button class="btn btn-primary mb-4" (click)="openCreateModal(currentConfig.endpoint)">Создать запись</button>
    <p-table [value]="data" class="invoice-table">
        <ng-template pTemplate="header">
            <tr>
                <ng-container *ngFor="let col of columns">
                    <th class="filter-header" [style.width]="col.width">
                        <div style="display: flex; justify-content: space-between;">
                            <app-search-filter-sort *ngIf="col.type == 'string'" [filterField]="col.field"
                                [filterType]="1" (filterChange)="referenceBookService.onFilterChange($event)"
                                (sortChange)="referenceBookService.onSortChange($event)"
                                [isVisibleFilter]="col.isFilter">
                            </app-search-filter-sort>

                            <!-- Аналогичные кнопки для других типов фильтров -->
                            <app-date-filter *ngIf="col.type == 'date'" [filterField]="col.field"
                                (filterChange)="referenceBookService.onFilterChange($event)"
                                (sortChange)="referenceBookService.onSortChange($event)">
                            </app-date-filter>

                            <app-number-filter *ngIf="col.type == 'number'" [filterField]="col.field"
                                (filterChange)="referenceBookService.onFilterChange($event)"
                                (sortChange)="referenceBookService.onSortChange($event)">
                            </app-number-filter>

                            <app-uuid-search-filter-sort *ngIf="col.type == 'uuid'" [apiEndpoint]="col.endpoint"
                                [fieldNames]="''" [enam]="null" [Field]="col.field"
                                (filterChange)="referenceBookService.onFilterChange($event)"
                                (sortChange)="referenceBookService.onSortChange($event)">
                            </app-uuid-search-filter-sort>

                            <app-uuid-search-filter-sort *ngIf="col.type == 'enam'" [fieldNames]="'label'"
                                [Field]="col.field" [filterType]="1"
                                (filterChange)="referenceBookService.onFilterChange($event)"
                                (sortChange)="referenceBookService.onSortChange($event)">
                            </app-uuid-search-filter-sort>

                        </div>
                    </th>
                </ng-container>
            </tr>
            <tr>
                <ng-container *ngFor="let col of columns">
                    <th [style.width]="col.width">{{ col.header }}</th>
                </ng-container>
                <th></th>
            </tr>
           
        </ng-template>

        <ng-template pTemplate="body" let-product>
            <tr class="invoice-row" (dblclick)="openEditModal(product)">
                <ng-container *ngFor="let col of columns">
                    <td *ngIf="col.type != 'actions'" class="invoice-cell" (dblclick)="openEditModal(product)"
                        (contextmenu)="onRightClick($event, product)" [style.width]="col.width">
                        <ng-container *ngIf="col.field === 'dateTime'; else normalField">
                            {{ product[col.field] | date: 'dd-MM-yyyy' }}
                        </ng-container>
                        <ng-template #normalField>
                            <span>
                                {{ product[col.field] }}
                            </span>
                        </ng-template>
                    </td>
                </ng-container>
                <td class="invoice-cell actions-cell">
                    <div class="dropdown">
                        <button class="btn btn-dropdown" style="color: #101010;"
                            (click)="toggleDropdown(product.id)">⋮</button>
                        <div class="dropdown-menu" [ngClass]="{'show': dropdownVisible[product.id]}">
                            <!-- <ng-container *ngFor="let button of getButtonSet()">
                                <button class="btn btn-details"
                                    *ngIf="button.condition ? button.condition(product) : true"
                                    [ngClass]="button.class" (click)="handleButtonClick(button, product)"
                                    [title]="button.titlePopUp">
                                    {{ button.label }}
                                </button>
                            </ng-container> -->
                            <button class="btn btn-details" (click)="openEditModal(product)">
                                Изменить
                            </button>
                            <button class="btn btn-details" (click)="deleteRecord(product.id)">
                                Удалить
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>




    <div class="modal" *ngIf="isModalOpen" [ngClass]="{ 'open': isModalOpen }">
        <div class="modal-content">
            <span class="close-btn" (click)="closeModal()">×</span>
            <h2>{{ modalTitle }}</h2>

            <form>
                <div class="form-group-container" [ngClass]="{'two-columns': formFields.length > 4}">
                    <div class="form-group" *ngFor="let field of formFields">
                        <label [for]="field.field">{{ field.label }}:</label>
                        <input *ngIf="field.type === 'text'" id="{{ field.field }}" [(ngModel)]="modalData[field.field]"
                            name="{{ field.field }}" class="form-control" required type="text" />

                        <input *ngIf="field.type === 'date'" id="{{ field.field }}" [(ngModel)]="modalData[field.field]"
                            name="{{ field.field }}" class="form-control" required type="date" />

                        <input *ngIf="field.type === 'number'" id="{{ field.field }}"
                            [(ngModel)]="modalData[field.field]" name="{{ field.field }}" class="form-control" required
                            type="number" />
                    </div>
                </div>

                <button (click)="onSubmit(currentConfig.endpoint)" type="submit" class="btn btn-success">{{ modalAction
                    }}</button>
            </form>

        </div>
    </div>
</div>



<!-- Контекстное меню -->
<div *ngIf="contextMenuVisible" class="context-menu" [style.top.px]="contextMenuY" [style.left.px]="contextMenuX">

    <button class="btn btn-details" (click)="openEditModal(modalData)">
        Изменить
    </button>
    <button class="btn btn-details" (click)="deleteRecord(modalData.id)">
        Удалить
    </button>
</div>